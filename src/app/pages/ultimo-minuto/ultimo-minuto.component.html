<div class="ultimo-minuto-container">
    <div class="page-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="page-title">
                    <span class="live-indicator">●</span>
                    Último Minuto
                </h1>
                <p class="page-subtitle">Noticias de última hora en tiempo real</p>
            </div>
            <div class="header-actions">
                <button class="refresh-btn" (click)="refreshNews()" [disabled]="refreshing">
                    <svg class="refresh-icon" [class.spinning]="refreshing" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    <span>Actualizar</span>
                </button>
                <span class="status-message" *ngIf="refreshing && statusMessage">{{ statusMessage }}</span>
                <div class="auto-refresh-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" [(ngModel)]="autoRefresh" (change)="toggleAutoRefresh()">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Auto-refresh</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label class="filter-label">Fuente:</label>
            <select class="filter-select" [(ngModel)]="sourceFilter">
                <option value="all">Todas</option>
                <option *ngFor="let source of sources" [value]="source.id">
                    {{ source.name }}
                </option>
            </select>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loading">
        <div class="spinner"></div>
        <p>Cargando últimas noticias...</p>
    </div>

    <!-- News Grid -->
    <div class="news-grid" *ngIf="!loading">
        <div class="news-card" *ngFor="let news of paginatedNews" [class.selected]="isNewsSelected(news.id)">
            <div class="selection-checkbox" (click)="toggleNewsSelection(news, $event)">
                <div class="checkbox-box" [class.checked]="isNewsSelected(news.id)">
                    <svg *ngIf="isNewsSelected(news.id)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
            </div>
            <div class="news-badge" [class]="getPriorityClass(news.priority)">
                {{ getPriorityText(news.priority) }}
            </div>
            <div class="news-content">
                <div class="news-header">
                    <!-- <span class="news-category">{{ news.category }}</span> -->
                    <span class="news-time">{{ news.timeAgo }}</span>
                </div>
                <h3 class="news-title">
                    <a [href]="news.url" target="_blank" style="text-decoration: none; color: inherit;">
                        {{ news.title }}
                    </a>
                </h3>
                <p class="news-excerpt">{{ news.content.substring(0, 150) }}...</p>
                <div class="news-footer">
                    <div class="news-source">
                        <svg class="source-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        {{ news.source }}
                    </div>
                    <button class="add-to-broadcast-btn" (click)="openExpressPanel(news)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Agregar
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="filteredNews.length === 0">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p>No hay noticias de última hora disponibles</p>
            <p class="empty-hint">Intenta actualizar la página o cambiar los filtros</p>
        </div>

        <!-- Pagination -->
        <div class="pagination" *ngIf="filteredNews.length > itemsPerPage">
            <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
                Anterior
            </button>
            <span class="page-info">Página {{ currentPage }} de {{ totalPages }}</span>
            <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
                Siguiente
            </button>
        </div>
    </div>

    <!-- Floating Action Button for Batch Processing -->
    <div class="broadcast-fab" *ngIf="selectedNewsCount > 0" (click)="openExpressPanel()">
        <div class="fab-content">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span>Configurar Noticias ({{ selectedNewsCount }})</span>
        </div>
    </div>

    <!-- Express News Panel (Unified) -->
    <div id="express-news-panel" class="express-panel" *ngIf="showExpressPanel && activeItem">
        <div class="panel-header">
            <h3>Configuración Noticia Express</h3>
            <button class="close-btn" (click)="closeExpressPanel()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>

        <!-- Tabs for multiple items -->
        <div class="express-tabs" *ngIf="expressItemsList.length > 1">
            <div class="tab-item" 
                 *ngFor="let item of expressItemsList" 
                 [class.active]="item.id === activeExpressItemId"
                 [class.saved]="item.status === 'saved'"
                 (click)="selectTab(item.id)">
                 <span class="tab-status-dot" [class.ready]="item.status === 'saved'"></span>
                 <span class="tab-title">{{ item.originalNews.title }}</span>
            </div>
        </div>
        
        <div class="panel-content">
            <div class="original-content">
                <label>Noticia Original:</label>
                <div class="text-preview">{{ activeItem.originalNews.content }}</div>
            </div>

            <div class="actions-row">
                <button class="action-btn humanize-btn" (click)="humanizeNews()" [disabled]="activeItem.isHumanizing">
                    <svg *ngIf="!activeItem.isHumanizing" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M12 12L2.1 12a10.1 10.1 0 0 0 1.5 4"></path><path d="M12 12l8.5 6"></path></svg>
                    <span *ngIf="activeItem.isHumanizing" class="spinner-small"></span>
                    Humanizar Noticia
                </button>
            </div>

            <div class="humanized-content">
                <label>Texto Humanizado:</label>
                
                <!-- Voice Configuration Controls -->
                <div class="voice-controls-panel">
                    <div class="azure-controls" style="margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <div class="control-row" style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div class="control-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9em;">Voz (Azure Neural):</label>
                                <select [(ngModel)]="activeItem.voiceSettings.voice" style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px;">
                                    <option *ngFor="let voice of azureVoices" [value]="voice.name">
                                        {{ voice.label }}
                                    </option>
                                </select>
                            </div>
                            <div class="control-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9em;">Velocidad: {{ activeItem.voiceSettings.speed }}x</label>
                                <input type="range" [(ngModel)]="activeItem.voiceSettings.speed" min="0.2" max="10.0" step="0.1" class="speed-slider" style="width: 100%;">
                            </div>
                            <div class="control-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9em;">Tono: {{ activeItem.voiceSettings.pitch || 1.0 }}</label>
                                <input type="range" [(ngModel)]="activeItem.voiceSettings.pitch" min="0.2" max="10.0" step="0.1" class="speed-slider" style="width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>

                <textarea id="humanizedTextarea" [(ngModel)]="activeItem.humanizedText" rows="6" placeholder="El texto humanizado aparecerá aquí..."></textarea>
            </div>

            <div class="audio-section" *ngIf="activeItem.humanizedText">
                <button class="action-btn audio-btn" (click)="generateAudio()" [disabled]="activeItem.isGeneratingAudio">
                    <svg *ngIf="!activeItem.isGeneratingAudio" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    <span *ngIf="activeItem.isGeneratingAudio" class="spinner-small"></span>
                    Generar Audio
                </button>

                <div class="audio-player" *ngIf="activeItem.generatedAudioUrl">
                    <audio controls [src]="activeItem.generatedAudioUrl"></audio>
                </div>
            </div>

            <div class="panel-footer">
                <button class="save-btn" (click)="saveExpressNews()" [disabled]="!activeItem.humanizedText || isSavingExpress || activeItem.status === 'saved'">
                    <span *ngIf="isSavingExpress" class="spinner-small"></span>
                    {{ activeItem.status === 'saved' ? 'Guardado ✓' : 'Guardar Noticia' }}
                </button>

                <button class="save-btn broadcast-btn" 
                        *ngIf="expressItemsList.length > 0"
                        (click)="createExpressBroadcast()" 
                        [disabled]="isSavingExpress || !hasSavedItems">
                    <span *ngIf="isSavingExpress" class="spinner-small"></span>
                    Crear Noticiero Express ({{ savedItemsCount }}/{{ expressItemsList.length }})
                </button>
            </div>
        </div>
    </div>
</div>
